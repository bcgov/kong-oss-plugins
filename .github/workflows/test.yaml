name: Playwright E2E Tests

on:
  workflow_dispatch: {}
  push:
    branches: ["cleanup"]
#     branches: ['test', 'cypress/*']
#   pull_request:
#     branches: ['dev']

# env:
#   EXECUTION_ENV: prod
#   GIT_COMMIT_BRANCH: ${{ github.ref_name }}
#   GIT_COMMIT_SHA: ${{ github.sha }}
#   GIT_COMMIT_AUTHOR: ${{ github.actor }}
#   GIT_COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
#   GIT_REPO_URL: ${{ github.repository }}

jobs:
  playwright-run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Build Docker Images
        working-directory: testsuite
        run: |
          docker compose -f docker-compose.yml -f docker-compose-keycloak-quarkus.yml build

      - name: Spin up Kong and its dependencies and Run E2E Tests
        working-directory: testsuite
        run: |
          export CI=true
          docker compose -f docker-compose.yml -f docker-compose-keycloak-quarkus.yml up -d

      - name: Execute Tests & Clean Up
        working-directory: testsuite
        run: |
          # Start following logs in the background with continuous output
          docker logs -f e2e-playwright-1 2>&1 &
          LOG_PID=$!

          while true; do
            if [ "$(docker ps -aq -f status=exited -f name=playwright)" ]; then
              echo "E2E tests completed."
              # cleanup
              docker compose -f docker-compose.yml -f docker-compose-keycloak-quarkus.yml down
              break
            else
              sleep 30s
            fi
          done
